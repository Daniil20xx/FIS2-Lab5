name: Trivy Scan

on:
  push:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -t juice-shop:latest .

    - name: Install Trivy
      run: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

<<<<<<< HEAD
    - name: Generate reports without template issues
      run: |
        trivy image --format json --output trivy-results.json juice-shop:latest
      
        trivy image --format table --output trivy-table.txt juice-shop:latest
        
        echo "<html><body><h1>Trivy Security Report</h1><h2>juice-shop:latest</h2>" > trivy-report.html
        echo "<h3>Vulnerabilities:</h3><pre>" >> trivy-report.html
        cat trivy-table.txt >> trivy-report.html
        echo "</pre></body></html>" >> trivy-report.html
=======
    - name: Scan image with local HTML template
      run: |
        trivy image --format template \
          --template .github/trivy-templates/html.tpl \
          --output trivy-report.html \
          juice-shop:latest
>>>>>>> e3d04702aa88af49627ad12cc0f5056cdd8b479e

    - name: Generate SBOM
      run: |
        trivy image --format cyclonedx --output sbom.cyclonedx.json juice-shop:latest

    - name: Upload Trivy scan report
      uses: actions/upload-artifact@v4
      with:
        name: trivy-security-report
        path: trivy-report.html

    - name: Upload SBOM
      uses: actions/upload-artifact@v4
      with:
        name: sbom-cyclonedx
        path: sbom.cyclonedx.json